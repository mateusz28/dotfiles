#!/bin/bash
AICOM_MODEL="opencode/big-pickle"
function check_step(){
  echo -n "$1  (Y/n)?"; read CONT; [ "$CONT" = "n" ] && exit 0
}
is_in_git_repo() {
  git rev-parse HEAD > /dev/null 2>&1
}
is_in_git_repo || return

DIFF_FILE=$(mktemp)
trap 'rm -f "$DIFF_FILE"' EXIT
git diff --cached > "$DIFF_FILE"

PROMPT="Output only 3 conventional commit message lines (type: description), no other text. Propose 3 commit messages for the attached staged diff."
RUN_ARGS=("$PROMPT" -f "$DIFF_FILE")
[ -n "${AICOM_MODEL:-}" ] && RUN_ARGS=("$PROMPT" -m "$AICOM_MODEL" -f "$DIFF_FILE")
OPCOUT=$(opencode run "${RUN_ARGS[@]}" 2>&1)
CANDIDATES=$(echo "$OPCOUT" | grep -oE '(feat|fix|docs|style|refactor|test|chore|perf|ci|build)(\([a-zA-Z0-9_-]+\))?:[^[:cntrl:]]*' | head -5)
[ -z "$CANDIDATES" ] && CANDIDATES=$(echo "$OPCOUT" | grep -E '^[^#]*: .+' | sed 's/^[[:space:]]*[0-9.]*[[:space:]]*//' | head -5)
[ -z "$CANDIDATES" ] && CANDIDATES=$(echo "$OPCOUT" | grep -v '^[[:space:]]*$' | grep -v '^#' | sed 's/^[[:space:]]*[-*0-9.]*[[:space:]]*//' | head -5)
[ -z "$CANDIDATES" ] && { echo "No commit messages parsed. Raw output:"; echo "$OPCOUT" | tail -30; exit 1; }
MSG=$(echo "$CANDIDATES" | fzf)
[ -z "$MSG" ] && exit 0

# Remove any quotes, single quotes, backticks, and leading/trailing whitespace from MSG
MSG=$(echo "$MSG" | tr -d '\"'\''`' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

CMD="git commit -m \"$MSG\""
echo "Calling: $CMD"
check_step Continue
eval "$CMD"


